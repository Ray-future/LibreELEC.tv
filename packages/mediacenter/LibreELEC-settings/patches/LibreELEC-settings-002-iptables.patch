From d3e19e7a902ecda4f6060a4abb3f016337461640 Mon Sep 17 00:00:00 2001
From: Radostan Riedel <raybuntu@googlemail.com>
Date: Wed, 25 Oct 2017 14:46:11 +0200
Subject: [PATCH] connman.py: Switch for iptables netfilter rules

---
 language/English/strings.po          |  8 ++++++++
 src/defaults.py                      |  1 +
 src/resources/lib/modules/connman.py | 25 +++++++++++++++++++++++++
 3 files changed, 34 insertions(+)

diff --git a/language/English/strings.po b/language/English/strings.po
index e323d61..d451429 100644
--- a/language/English/strings.po
+++ b/language/English/strings.po
@@ -252,6 +252,10 @@ msgctxt "#770"
 msgid "Select an available version"
 msgstr ""
 
+msgctxt "#771"
+msgid "Set to ON to enable Network Filter (iptables)"
+msgstr ""
+
 msgctxt "#32001"
 msgid "Services"
 msgstr ""
@@ -831,3 +835,7 @@ msgstr ""
 msgctxt "#32392"
 msgid "Enable Lirc"
 msgstr ""
+
+msgctxt "#32393"
+msgid "Firewall"
+msgstr ""
diff --git a/src/defaults.py b/src/defaults.py
index e381999..56f1ea7 100644
--- a/src/defaults.py
+++ b/src/defaults.py
@@ -116,4 +116,5 @@
     'obexd': ['obex.service'],
     'crond': ['cron.service'],
     'lircd': ['lircd.service', 'lircd-uinput.service'],
+    'iptables': ['iptables.service'],
     }
diff --git a/src/resources/lib/modules/connman.py b/src/resources/lib/modules/connman.py
index 09b9e46..e238485 100644
--- a/src/resources/lib/modules/connman.py
+++ b/src/resources/lib/modules/connman.py
@@ -2,6 +2,7 @@
 #      This file is part of OpenELEC - http://www.openelec.tv
 #      Copyright (C) 2009-2013 Stephan Raue (stephan@openelec.tv)
 #      Copyright (C) 2013 Lutz Fiebach (lufie@openelec.tv)
+#      Copyright (C) 2017-present Team LibreELEC
 #
 #  This program is dual-licensed; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -646,6 +647,14 @@ def __init__(self, oeMain):
                                 },
                             'InfoText': 737,
                             },
+                        'netfilter': {
+                            'order': 1,
+                            'name': 32393,
+                            'value': '1',
+                            'action': 'enable_netfilter',
+                            'type': 'bool',
+                            'InfoText': 771,
+                            },
                         },
                     'order': 4,
                     },
@@ -1145,6 +1154,22 @@ def set_network_wait(self, **kwargs):
         except Exception, e:
             self.oe.dbg_log('system::set_network_wait', 'ERROR: (' + repr(e) + ')')
 
+    def enable_netfilter(self, **kwargs):
+        try:
+            self.oe.dbg_log('connman::enable_netfilter', 'enter_function', 0)
+            self.oe.set_busy(1)
+            if 'listItem' in kwargs:
+                self.set_value(kwargs['listItem'])
+            state = 1
+            options = {}
+            if self.struct['advanced']['settings']['netfilter']['value'] != '1':
+                state = 0
+            self.oe.set_service('iptables', options, state)
+            self.oe.set_busy(0)
+            self.oe.dbg_log('connman::enable_netfilter', 'exit_function', 0)
+        except Exception, e:
+            self.oe.dbg_log('system::enable_netfilter', 'ERROR: (' + repr(e) + ')')
+
     def do_wizard(self):
         try:
             self.oe.dbg_log('connman::do_wizard', 'enter_function', 0)
